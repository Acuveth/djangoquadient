{% extends "base.html" %}

{% block title %}Analytics Dashboard | Quadient API Client{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<style>
    .card {
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: bold;
    }
    .stat-card {
        text-align: center;
        padding: 15px 10px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .stat-card .stat-value {
        font-size: 24px;
        font-weight: bold;
    }
    .stat-card .stat-label {
        font-size: 14px;
        color: #6c757d;
    }
    .insights-box {
        background-color: #e9f0fd;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        font-size: 14px;
    }
    .insights-box strong {
        color: #0d6efd;
    }
    .alert-status {
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    .alert-normal {
        background-color: #d1e7dd;
    }
    .alert-warning {
        background-color: #fff3cd;
    }
    .alert-danger {
        background-color: #f8d7da;
    }
    .chart-container {
        height: 300px;
        margin-bottom: 20px;
    }
    .loading-spinner {
        text-align: center;
        padding: 50px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Quadient Messenger Analytics Dashboard</h1>
        <p class="text-muted">Comprehensive analytics for your email campaigns</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="batch-select" class="form-label">Select Batch:</label>
                        <select id="batch-select" class="form-select">
                            <option value="" disabled selected>Loading batches...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="load-data-btn" class="btn btn-primary mt-4">Load Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading spinner -->
<div id="loading-indicator" class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading analytics data...</p>
</div>

<!-- Dashboard content (hidden until data loads) -->
<div id="dashboard-content" style="display: none;">
    <!-- Batch Overview Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-label">Total Messages</div>
                <div id="total-messages" class="stat-value">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-label">Delivered</div>
                <div id="delivered-messages" class="stat-value">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-label">Opened</div>
                <div id="opened-messages" class="stat-value">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-label">Open Rate</div>
                <div id="open-rate" class="stat-value">0%</div>
            </div>
        </div>
    </div>

    <!-- Device and Client Analytics -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-laptop"></i> Device and Client Analytics
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h5 class="text-center mb-3">Operating Systems</h5>
                    <div class="chart-container">
                        <canvas id="os-chart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 class="text-center mb-3">Email Clients & Browsers</h5>
                    <div class="chart-container">
                        <canvas id="browser-chart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 class="text-center mb-3">Device Types</h5>
                    <div class="chart-container">
                        <canvas id="device-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="insights-box">
                <strong>INSIGHTS:</strong> <span id="device-insights">Desktop users make up the majority, with Windows being the dominant OS. Chrome leads browser usage, followed by Safari. Consider optimizing for these platforms while ensuring mobile compatibility.</span>
            </div>
        </div>
    </div>

    <!-- Time-Based Analytics -->
    <div class="card mt-4">
        <div class="card-header">
            <i class="bi bi-clock"></i> Time-Based Analytics
        </div>
        <div class="card-body">
            <h5 class="mb-3">Engagement by Hour of Day</h5>
            <div class="chart-container">
                <canvas id="time-chart"></canvas>
            </div>
            <div class="insights-box">
                <strong>INSIGHTS:</strong> <span id="time-insights">Peak engagement occurs between 9:00-11:00 and 15:00-17:00, suggesting optimal sending times during mid-morning and mid-afternoon. Consider scheduling important campaigns during these peak hours for maximum impact.</span>
            </div>
        </div>
    </div>

    <!-- Compliance and Unsubscribe Monitoring -->
    <div class="card mt-4">
        <div class="card-header">
            <i class="bi bi-shield-check"></i> Compliance and Unsubscribe Monitoring
        </div>
        <div class="card-body">
            <h5 class="mb-3">Unsubscribe and Spam Complaint Rates (Last 7 Days)</h5>
            <div class="chart-container">
                <canvas id="compliance-chart"></canvas>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div id="unsubscribe-alert" class="alert-status">
                        <h6 class="mb-2">Unsubscribe Rate Alert</h6>
                        <div class="d-flex justify-content-between">
                            <div>
                                <p class="mb-1">Current: <span id="current-unsubscribe">0.0%</span></p>
                                <p class="small mb-0">Threshold: 0.50%</p>
                            </div>
                            <div id="unsubscribe-status" class="fw-bold">NORMAL</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div id="spam-alert" class="alert-status">
                        <h6 class="mb-2">Spam Complaint Alert</h6>
                        <div class="d-flex justify-content-between">
                            <div>
                                <p class="mb-1">Current: <span id="current-spam">0.0%</span></p>
                                <p class="small mb-0">Threshold: 0.10%</p>
                            </div>
                            <div id="spam-status" class="fw-bold">NORMAL</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="insights-box">
                <strong>INSIGHTS:</strong> <span id="compliance-insights">Unsubscribe rates are within normal range. Monitor for any unusual spikes that may indicate content or targeting issues.</span>
            </div>
        </div>
    </div>

    <div class="text-muted small mt-4 mb-5">
        <p>This dashboard uses the Quadient Messenger REST API to analyze batch statistics and message engagement patterns.</p>
        <p>Data is fetched from the actual API endpoints defined in the Quadient API documentation.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const batchSelect = document.getElementById('batch-select');
        const loadDataBtn = document.getElementById('load-data-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const dashboardContent = document.getElementById('dashboard-content');
        
        // Chart objects
        let osChart, browserChart, deviceChart, timeChart, complianceChart;
        
        // Function to populate batch dropdown
        function loadBatches() {
            // In a real implementation, this would fetch from your Django view
            // For now, we'll use mock data
            const mockBatches = [
                { id: 1, name: "March Newsletter", type: "Email", numberOfRecords: 5000 },
                { id: 2, name: "Product Announcement", type: "Email", numberOfRecords: 3500 },
                { id: 3, name: "Weekly Update", type: "Email", numberOfRecords: 2800 }
            ];
            
            // Clear existing options
            batchSelect.innerHTML = '';
            
            // Add options
            mockBatches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = `${batch.name} (${batch.type}) - ${batch.numberOfRecords} records`;
                batchSelect.appendChild(option);
            });
        }
        
        // Load batches on page load
        loadBatches();
        
        // Handle load data button click
        loadDataBtn.addEventListener('click', function() {
            if (!batchSelect.value) return;
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            dashboardContent.style.display = 'none';
            
            // Simulate API delay
            setTimeout(function() {
                loadAnalyticsData(batchSelect.value);
            }, 1000);
        });
        
        // Function to load analytics data for selected batch
        function loadAnalyticsData(batchId) {
            // In a real implementation, this would fetch from your Django view
            // For demo purposes, we're using mock data
            
            // Mock batch details
            const batchDetails = {
                id: batchId,
                name: batchSelect.options[batchSelect.selectedIndex].text.split(' (')[0],
                numberOfRecords: parseInt(batchId) * 1000 + 2000,
                delivered: parseInt(batchId) * 950 + 1950,
                opened: parseInt(batchId) * 550 + 1500
            };
            
            // Mock device statistics
            const deviceStats = {
                clientOS: [
                    { name: "Windows", value: 45 },
                    { name: "MacOS", value: 25 },
                    { name: "iOS", value: 15 },
                    { name: "Android", value: 12 },
                    { name: "Linux", value: 3 }
                ],
                clientBrowser: [
                    { name: "Chrome", value: 38 },
                    { name: "Safari", value: 22 },
                    { name: "Outlook", value: 18 },
                    { name: "Gmail", value: 12 },
                    { name: "Firefox", value: 6 },
                    { name: "Edge", value: 4 }
                ],
                deviceType: [
                    { name: "Desktop", value: 65 },
                    { name: "Mobile", value: 35 }
                ]
            };
            
            // Mock time-based data
            const timeData = Array.from({length: 24}, (_, i) => ({
                hour: i,
                opens: Math.floor(Math.random() * 150) + 50,
                clicks: Math.floor(Math.random() * 80) + 20
            }));
            
            // Mock compliance data
            const complianceData = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - 6 + i);
                return {
                    date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    unsubscribeRate: (Math.random() * 0.7 + 0.2).toFixed(2),
                    spamRate: (Math.random() * 0.15).toFixed(2)
                };
            });
            
            // Update the UI with the fetched data
            updateDashboard(batchDetails, deviceStats, timeData, complianceData);
        }
        
        // Function to update dashboard UI with data
        function updateDashboard(batchDetails, deviceStats, timeData, complianceData) {
            // Update batch overview stats
            document.getElementById('total-messages').textContent = batchDetails.numberOfRecords.toLocaleString();
            document.getElementById('delivered-messages').textContent = batchDetails.delivered.toLocaleString();
            document.getElementById('opened-messages').textContent = batchDetails.opened.toLocaleString();
            
            const openRate = ((batchDetails.opened / batchDetails.delivered) * 100).toFixed(1);
            document.getElementById('open-rate').textContent = openRate + '%';
            
            // Create or update charts
            createDeviceCharts(deviceStats);
            createTimeChart(timeData);
            createComplianceChart(complianceData);
            
            // Update compliance alerts
            updateComplianceAlerts(complianceData[complianceData.length - 1]);
            
            // Hide loading indicator and show dashboard
            loadingIndicator.style.display = 'none';
            dashboardContent.style.display = 'block';
        }
        
        // Create device and client charts
        function createDeviceCharts(deviceStats) {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            };
            
            // OS Chart
            const osCtx = document.getElementById('os-chart').getContext('2d');
            if (osChart) osChart.destroy();
            osChart = new Chart(osCtx, {
                type: 'pie',
                data: {
                    labels: deviceStats.clientOS.map(item => item.name),
                    datasets: [{
                        data: deviceStats.clientOS.map(item => item.value),
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                        ]
                    }]
                },
                options: chartOptions
            });
            
            // Browser Chart
            const browserCtx = document.getElementById('browser-chart').getContext('2d');
            if (browserChart) browserChart.destroy();
            browserChart = new Chart(browserCtx, {
                type: 'pie',
                data: {
                    labels: deviceStats.clientBrowser.map(item => item.name),
                    datasets: [{
                        data: deviceStats.clientBrowser.map(item => item.value),
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                        ]
                    }]
                },
                options: chartOptions
            });
            
            // Device Type Chart
            const deviceCtx = document.getElementById('device-chart').getContext('2d');
            if (deviceChart) deviceChart.destroy();
            deviceChart = new Chart(deviceCtx, {
                type: 'pie',
                data: {
                    labels: deviceStats.deviceType.map(item => item.name),
                    datasets: [{
                        data: deviceStats.deviceType.map(item => item.value),
                        backgroundColor: ['#4e73df', '#1cc88a']
                    }]
                },
                options: chartOptions
            });
        }
        
        // Create time-based chart
        function createTimeChart(timeData) {
            const timeCtx = document.getElementById('time-chart').getContext('2d');
            if (timeChart) timeChart.destroy();
            
            timeChart = new Chart(timeCtx, {
                type: 'bar',
                data: {
                    labels: timeData.map(item => `${item.hour}:00`),
                    datasets: [
                        {
                            label: 'Opens',
                            data: timeData.map(item => item.opens),
                            backgroundColor: '#4e73df'
                        },
                        {
                            label: 'Clicks',
                            data: timeData.map(item => item.clicks),
                            backgroundColor: '#1cc88a'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    }
                }
            });
        }
        
        // Create compliance chart
        function createComplianceChart(complianceData) {
            const complianceCtx = document.getElementById('compliance-chart').getContext('2d');
            if (complianceChart) complianceChart.destroy();
            
            complianceChart = new Chart(complianceCtx, {
                type: 'line',
                data: {
                    labels: complianceData.map(item => item.date),
                    datasets: [
                        {
                            label: 'Unsubscribe Rate (%)',
                            data: complianceData.map(item => item.unsubscribeRate),
                            borderColor: '#f6c23e',
                            backgroundColor: 'rgba(246, 194, 62, 0.1)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Spam Complaint Rate (%)',
                            data: complianceData.map(item => item.spamRate),
                            borderColor: '#e74a3b',
                            backgroundColor: 'rgba(231, 74, 59, 0.1)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update compliance alerts
        function updateComplianceAlerts(currentData) {
            const unsubscribeAlert = document.getElementById('unsubscribe-alert');
            const spamAlert = document.getElementById('spam-alert');
            const unsubscribeStatus = document.getElementById('unsubscribe-status');
            const spamStatus = document.getElementById('spam-status');
            const currentUnsubscribe = document.getElementById('current-unsubscribe');
            const currentSpam = document.getElementById('current-spam');
            const complianceInsights = document.getElementById('compliance-insights');
            
            // Set current values
            currentUnsubscribe.textContent = currentData.unsubscribeRate + '%';
            currentSpam.textContent = currentData.spamRate + '%';
            
            // Unsubscribe alert status
            if (parseFloat(currentData.unsubscribeRate) > 0.5) {
                unsubscribeAlert.className = 'alert-status alert-danger';
                unsubscribeStatus.textContent = 'ALERT';
                unsubscribeStatus.className = 'fw-bold text-danger';
            } else if (parseFloat(currentData.unsubscribeRate) > 0.4) {
                unsubscribeAlert.className = 'alert-status alert-warning';
                unsubscribeStatus.textContent = 'WARNING';
                unsubscribeStatus.className = 'fw-bold text-warning';
            } else {
                unsubscribeAlert.className = 'alert-status alert-normal';
                unsubscribeStatus.textContent = 'NORMAL';
                unsubscribeStatus.className = 'fw-bold text-success';
            }
            
            // Spam alert status
            if (parseFloat(currentData.spamRate) > 0.1) {
                spamAlert.className = 'alert-status alert-danger';
                spamStatus.textContent = 'ALERT';
                spamStatus.className = 'fw-bold text-danger';
            } else if (parseFloat(currentData.spamRate) > 0.08) {
                spamAlert.className = 'alert-status alert-warning';
                spamStatus.textContent = 'WARNING';
                spamStatus.className = 'fw-bold text-warning';
            } else {
                spamAlert.className = 'alert-status alert-normal';
                spamStatus.textContent = 'NORMAL';
                spamStatus.className = 'fw-bold text-success';
            }
            
            // Update insights based on current data
            if (parseFloat(currentData.unsubscribeRate) > 0.5 || parseFloat(currentData.spamRate) > 0.1) {
                complianceInsights.textContent = 'Compliance metrics exceeding thresholds! Urgent review of recent campaigns required to identify and address potential issues with content or targeting.';
            } else if (parseFloat(currentData.unsubscribeRate) > 0.4 || parseFloat(currentData.spamRate) > 0.08) {
                complianceInsights.textContent = 'Compliance metrics approaching thresholds. Consider reviewing campaign content and targeting strategies to prevent further increases.';
            } else {
                complianceInsights.textContent = 'Compliance metrics within normal ranges. Continue monitoring for any unusual patterns or spikes.';
            }
        }
    });
</script>
{% endblock %}